<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Wisdom - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: linear-gradient(135deg, #0a1128 0%, #001f54 50%, #0B3D91 100%);
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #fff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent-cyan: #00D9FF;
            --accent-green: #4ECDC4;
            --accent-orange: #FF6B35;
            --accent-purple: #9D4EDD;
            --accent-red: #FF006E;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 25s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(30px); opacity: 0; }
        }

        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            background: rgba(10, 17, 40, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 217, 255, 0.3);
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }

        .logo {
            font-size: 26px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-links a {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent-cyan);
        }

        .container {
            padding: 100px 3% 50px;
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 48px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .forecast-tabs {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 217, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            color: #0a1128;
            border-color: transparent;
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 217, 255, 0.5);
            box-shadow: 0 25px 70px rgba(0, 217, 255, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 24px;
            color: var(--accent-cyan);
        }

        #map {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(0, 217, 255, 0.3);
        }

        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            font-size: 14px;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .control-group input {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-group input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            border: none;
            border-radius: 50px;
            color: #0a1128;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 217, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange));
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .export-buttons button {
            padding: 10px;
            font-size: 14px;
            margin-top: 0;
        }

        .thresholds-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .comfort-display {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            margin: 20px 0;
        }

        .comfort-score-big {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid;
        }

        .badge-hot {
            background: rgba(255, 107, 53, 0.2);
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .badge-cold {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .badge-windy {
            background: rgba(78, 205, 196, 0.2);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .badge-wet {
            background: rgba(157, 78, 221, 0.2);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .badge-uncomfortable {
            background: rgba(255, 0, 110, 0.2);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .forecast-section {
            display: none;
        }

        .forecast-section.active {
            display: block;
        }

        .forecast-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .forecast-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-cyan);
        }

        .forecast-icon {
            font-size: 48px;
            margin: 15px 0;
        }

        .forecast-temp {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-cyan);
        }

        .probability-section {
            margin-top: 30px;
        }

        .probability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .probability-bar-container {
            width: 60%;
            height: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            overflow: hidden;
        }

        .probability-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan), var(--accent-orange));
            border-radius: 15px;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0a1128;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-cyan);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-error {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid var(--accent-orange);
            color: var(--accent-orange);
        }

        .alert-success {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert-info {
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 32px;
            }
            .thresholds-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <nav>
        <div class="logo">⚡ Weather Wisdom</div>
        <div class="nav-links">
            <a href="Landing Page.html">Home</a>
            <a href="DASH.html">Dashboard</a>
            <a href="About.html">About</a>
            <a href="Documentation Page.html">Documentation</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Weather Intelligence Dashboard</h1>
            <p>Historical analysis with hybrid forecasting and personalized insights</p>
        </div>

        <div class="forecast-tabs">
            <button class="tab-btn active" onclick="switchTab('analysis')">Historical Analysis</button>
            <button class="tab-btn" onclick="switchTab('shortterm')">7-Day Forecast</button>
            <button class="tab-btn" onclick="switchTab('mediumterm')">30-Day Outlook</button>
            <button class="tab-btn" onclick="switchTab('longterm')">Seasonal</button>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-section" class="forecast-section active">
            <div class="dashboard-grid">
                <div class="glass-card">
                    <div class="card-header">
                        <h2>Location & Date Selection</h2>
                        <div style="font-size: 32px;">📍</div>
                    </div>
                    <div id="map"></div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate" value="2024-01-01">
                        </div>
                        <div class="control-group">
                            <label>End Date</label>
                            <input type="date" id="endDate" value="2024-01-31">
                        </div>
                    </div>
                    <button class="btn" onclick="analyzeWeather()" id="analyzeBtn">
                        Analyze Weather Data
                    </button>
                    <div class="alert alert-info" id="mapAlert"></div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <h2>Custom Thresholds</h2>
                        <div style="font-size: 32px;">🎯</div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Define your personal comfort preferences for weather conditions
                    </p>
                    <div class="thresholds-grid">
                        <div class="control-group">
                            <label>Very Hot (°C)</label>
                            <input type="number" id="hotThreshold" value="35" min="20" max="50">
                        </div>
                        <div class="control-group">
                            <label>Very Cold (°C)</label>
                            <input type="number" id="coldThreshold" value="5" min="-20" max="20">
                        </div>
                        <div class="control-group">
                            <label>Very Windy (m/s)</label>
                            <input type="number" id="windyThreshold" value="10" min="5" max="30">
                        </div>
                        <div class="control-group">
                            <label>Very Wet (mm)</label>
                            <input type="number" id="wetThreshold" value="10" min="1" max="100">
                        </div>
                        <div class="control-group">
                            <label>High Humidity (%)</label>
                            <input type="number" id="humidityThreshold" value="80" min="50" max="100">
                        </div>
                        <div class="control-group">
                            <label>Comfort Temp (°C)</label>
                            <input type="number" id="comfortTemp" value="22" min="15" max="30">
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h2>Statistics Summary</h2>
                    <div style="font-size: 32px;">📊</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="avgTemp">--</div>
                        <div class="stat-label">Average Temperature</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="maxTemp">--</div>
                        <div class="stat-label">Maximum Temperature</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="minTemp">--</div>
                        <div class="stat-label">Minimum Temperature</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgPrecip">--</div>
                        <div class="stat-label">Avg Precipitation</div>
                    </div>
                </div>

                <div class="comfort-display">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Weather Comfort Index</h3>
                    <div class="comfort-score-big" id="comfortScore">--</div>
                    <p style="color: var(--text-secondary);" id="comfortDescription">
                        Select location and analyze to calculate comfort index
                    </p>
                </div>

                <div class="card-header" style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h3 style="color: var(--accent-cyan);">Condition Analysis</h3>
                </div>
                <div class="badges-container" id="conditionBadges">
                    <p style="color: var(--text-secondary);">Analyze data to see condition breakdown</p>
                </div>

                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportData('csv')" id="exportCsvBtn" disabled>
                        📥 Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('json')" id="exportJsonBtn" disabled>
                        📥 Export JSON
                    </button>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h2>Temperature & Precipitation Trends</h2>
                    <div style="font-size: 32px;">📈</div>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Short-term Tab -->
        <div id="shortterm-section" class="forecast-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>7-Day Weather Forecast</h2>
                    <div style="font-size: 32px;">🌤️</div>
                </div>
                <div class="control-group" style="margin-bottom: 20px;">
                    <label>OpenWeatherMap API Key (Optional for real forecasts)</label>
                    <input type="text" id="apiKey" placeholder="Enter your API key or use demo mode">
                </div>
                <button class="btn" onclick="generateShortTerm()" id="shortBtn">
                    Generate 7-Day Forecast
                </button>
                <div class="forecast-cards" id="shortterm-cards">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1/-1;">
                        Select location and generate forecast
                    </p>
                </div>
            </div>
        </div>

        <!-- Medium-term Tab -->
        <div id="mediumterm-section" class="forecast-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>30-Day Statistical Outlook</h2>
                    <div style="font-size: 32px;">📊</div>
                </div>
                <button class="btn" onclick="generateMediumTerm()" id="mediumBtn">
                    Generate 30-Day Outlook
                </button>
                <div class="probability-section" id="mediumterm-content">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        Select location and generate outlook
                    </p>
                </div>
                <div class="chart-container">
                    <canvas id="mediumChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Long-term Tab -->
        <div id="longterm-section" class="forecast-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>Seasonal Climate Outlook</h2>
                    <div style="font-size: 32px;">🌍</div>
                </div>
                <button class="btn" onclick="generateLongTerm()" id="longBtn">
                    Generate Seasonal Outlook
                </button>
                <div class="probability-section" id="longterm-content">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        Select location and generate seasonal outlook
                    </p>
                </div>
                <div class="chart-container">
                    <canvas id="longtermChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize particles
        const particlesContainer = document.getElementById('particles');
        for (let i = 0; i < 40; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 3 + 1 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (Math.random() * 15 + 20) + 's';
            particlesContainer.appendChild(particle);
        }

        // Initialize map
        const map = L.map('map').setView([31.9, 35.3], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        let marker = null;
        let selectedLocation = null;
        let weatherData = null;
        let charts = { main: null, medium: null, longterm: null };

        map.on('click', function(e) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            selectedLocation = e.latlng;
            showAlert('mapAlert', `Location: ${e.latlng.lat.toFixed(4)}°N, ${e.latlng.lng.toFixed(4)}°E`, 'info');
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.forecast-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');
        }

        async function analyzeWeather() {
            if (!selectedLocation) {
                showAlert('mapAlert', 'Please select a location on the map', 'error');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.innerHTML = '<span class="loading"></span>Analyzing...';
            btn.disabled = true;

            try {
                const startDate = document.getElementById('startDate').value.replace(/-/g, '');
                const endDate = document.getElementById('endDate').value.replace(/-/g, '');
                
                const params = 'T2M,PRECTOTCORR,RH2M,WS2M';
                const url = `https://power.larc.nasa.gov/api/temporal/daily/point?parameters=${params}&community=AG&longitude=${selectedLocation.lng}&latitude=${selectedLocation.lat}&start=${startDate}&end=${endDate}&format=JSON`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                
                weatherData = processData(data);
                updateUI(weatherData);
                
                document.getElementById('exportCsvBtn').disabled = false;
                document.getElementById('exportJsonBtn').disabled = false;
                
                showAlert('mapAlert', 'Analysis complete!', 'success');
                btn.innerHTML = 'Analysis Complete';
                setTimeout(() => {
                    btn.innerHTML = 'Analyze Weather Data';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                showAlert('mapAlert', 'Error: ' + error.message, 'error');
                btn.innerHTML = 'Analyze Weather Data';
                btn.disabled = false;
            }
        }

        function processData(data) {
            const params = data.properties.parameter;
            const dates = Object.keys(params.T2M || {});
            
            const temps = dates.map(d => params.T2M[d]).filter(v => v !== -999);
            const precips = dates.map(d => params.PRECTOTCORR[d]).filter(v => v !== -999);
            const humidities = dates.map(d => params.RH2M[d]).filter(v => v !== -999);
            const winds = dates.map(d => params.WS2M[d]).filter(v => v !== -999);
            
            const avgTemp = temps.reduce((a, b) => a + b, 0) / temps.length;
            const maxTemp = Math.max(...temps);
            const minTemp = Math.min(...temps);
            const avgPrecip = precips.reduce((a, b) => a + b, 0) / precips.length;
            
            const comfortScores = temps.map((t, i) => calculateComfortIndex(t, humidities[i], winds[i]));
            const avgComfort = comfortScores.reduce((a, b) => a + b, 0) / comfortScores.length;
            
            return {
                avgTemp: avgTemp.toFixed(1),
                maxTemp: maxTemp.toFixed(1),
                minTemp: minTemp.toFixed(1),
                avgPrecip: avgPrecip.toFixed(1),
                avgComfort: avgComfort.toFixed(0),
                dates: dates,
                temps: temps,
                precips: precips,
                humidities: humidities,
                winds: winds,
                rawData: data
            };
        }

        function calculateComfortIndex(temp, humidity, windSpeed) {
            const comfortTemp = parseFloat(document.getElementById('comfortTemp').value);
            let score = 100;
            
            const tempDiff = Math.abs(temp - comfortTemp);
            score -= Math.min(tempDiff * 2, 40);
            
            if (humidity > 70) {
                score -= (humidity - 70) * 0.5;
            }
            
            if (windSpeed > 5) {
                score -= (windSpeed - 5) * 2;
            }
            
            if (temp > 27 && humidity > 40) {
                const heatIndex = -8.78469 + 1.61139 * temp + 2.33854 * humidity - 
                                 0.14611 * temp * humidity - 0.01228 * temp * temp - 
                                 0.01644 * humidity * humidity + 0.002211 * temp * temp * humidity + 
                                 0.000728 * temp * humidity * humidity - 0.000004 * temp * temp * humidity * humidity;
                const hiDiff = heatIndex - temp;
                score -= hiDiff * 1.5;
            }
            
            return Math.max(0, Math.min(100, score));
        }

        function getComfortLabel(score) {
            if (score >= 80) return { label: 'Excellent', color: 'var(--accent-green)' };
            if (score >= 60) return { label: 'Good', color: 'var(--accent-cyan)' };
            if (score >= 40) return { label: 'Fair', color: 'var(--accent-orange)' };
            return { label: 'Poor', color: 'var(--accent-red)' };
        }

        function updateUI(data) {
            document.getElementById('avgTemp').textContent = data.avgTemp + '°C';
            document.getElementById('maxTemp').textContent = data.maxTemp + '°C';
            document.getElementById('minTemp').textContent = data.minTemp + '°C';
            document.getElementById('avgPrecip').textContent = data.avgPrecip + 'mm';
            
            const comfortInfo = getComfortLabel(parseFloat(data.avgComfort));
            const comfortEl = document.getElementById('comfortScore');
            comfortEl.textContent = data.avgComfort;
            comfortEl.style.background = `linear-gradient(135deg, ${comfortInfo.color}, var(--accent-purple))`;
            comfortEl.style.webkitBackgroundClip = 'text';
            comfortEl.style.webkitTextFillColor = 'transparent';
            
            document.getElementById('comfortDescription').textContent = 
                `${comfortInfo.label} comfort conditions based on temperature, humidity, and wind speed`;
            
            analyzeConditions(data);
            createChart(data);
        }

        function analyzeConditions(data) {
            const hotThreshold = parseFloat(document.getElementById('hotThreshold').value);
            const coldThreshold = parseFloat(document.getElementById('coldThreshold').value);
            const windyThreshold = parseFloat(document.getElementById('windyThreshold').value);
            const wetThreshold = parseFloat(document.getElementById('wetThreshold').value);
            const humidityThreshold = parseFloat(document.getElementById('humidityThreshold').value);
            const comfortTemp = parseFloat(document.getElementById('comfortTemp').value);
            
            const conditions = {
                hot: data.temps.filter(t => t > hotThreshold).length,
                cold: data.temps.filter(t => t < coldThreshold).length,
                windy: data.winds.filter(w => w > windyThreshold).length,
                wet: data.precips.filter(p => p > wetThreshold).length,
                uncomfortable: data.temps.map((t, i) => 
                    calculateComfortIndex(t, data.humidities[i], data.winds[i])
                ).filter(c => c < 40).length
            };
            
            const totalDays = data.temps.length;
            const container = document.getElementById('conditionBadges');
            container.innerHTML = '';
            
            const conditionTypes = [
                { key: 'hot', label: 'Very Hot', class: 'badge-hot', icon: '🔥' },
                { key: 'cold', label: 'Very Cold', class: 'badge-cold', icon: '❄️' },
                { key: 'windy', label: 'Very Windy', class: 'badge-windy', icon: '💨' },
                { key: 'wet', label: 'Very Wet', class: 'badge-wet', icon: '🌧️' },
                { key: 'uncomfortable', label: 'Uncomfortable', class: 'badge-uncomfortable', icon: '😓' }
            ];
            
            conditionTypes.forEach(type => {
                const count = conditions[type.key];
                const percentage = ((count / totalDays) * 100).toFixed(1);
                const badge = document.createElement('div');
                badge.className = `badge ${type.class}`;
                badge.textContent = `${type.icon} ${type.label}: ${count} days (${percentage}%)`;
                container.appendChild(badge);
            });
        }

        function createChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (charts.main) {
                charts.main.destroy();
            }
            
            const sampleSize = Math.min(30, data.dates.length);
            const step = Math.floor(data.dates.length / sampleSize);
            const chartDates = data.dates.filter((d, i) => i % step === 0).slice(0, sampleSize);
            const chartTemps = data.temps.filter((d, i) => i % step === 0).slice(0, sampleSize);
            const chartPrecips = data.precips.filter((d, i) => i % step === 0).slice(0, sampleSize);
            
            charts.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartDates.map(d => d.slice(4, 6) + '/' + d.slice(6, 8)),
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: chartTemps,
                        borderColor: 'var(--accent-cyan)',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Precipitation (mm)',
                        data: chartPrecips,
                        borderColor: 'var(--accent-green)',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#fff' } }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        function exportData(format) {
            if (!weatherData) {
                alert('No data to export. Please analyze weather data first.');
                return;
            }

            const exportData = {
                location: {
                    latitude: selectedLocation.lat,
                    longitude: selectedLocation.lng
                },
                period: {
                    start: document.getElementById('startDate').value,
                    end: document.getElementById('endDate').value
                },
                statistics: {
                    avgTemp: weatherData.avgTemp,
                    maxTemp: weatherData.maxTemp,
                    minTemp: weatherData.minTemp,
                    avgPrecip: weatherData.avgPrecip,
                    avgComfort: weatherData.avgComfort
                },
                thresholds: {
                    hot: document.getElementById('hotThreshold').value,
                    cold: document.getElementById('coldThreshold').value,
                    windy: document.getElementById('windyThreshold').value,
                    wet: document.getElementById('wetThreshold').value,
                    humidity: document.getElementById('humidityThreshold').value,
                    comfortTemp: document.getElementById('comfortTemp').value
                },
                dailyData: weatherData.dates.map((date, i) => ({
                    date: date,
                    temperature: weatherData.temps[i],
                    precipitation: weatherData.precips[i],
                    humidity: weatherData.humidities[i],
                    windSpeed: weatherData.winds[i],
                    comfortIndex: calculateComfortIndex(
                        weatherData.temps[i],
                        weatherData.humidities[i],
                        weatherData.winds[i]
                    ).toFixed(1)
                }))
            };

            if (format === 'json') {
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                downloadFile(blob, 'weather-analysis.json');
            } else if (format === 'csv') {
                let csv = 'Date,Temperature(°C),Precipitation(mm),Humidity(%),WindSpeed(m/s),ComfortIndex\n';
                exportData.dailyData.forEach(day => {
                    csv += `${day.date},${day.temperature},${day.precipitation},${day.humidity},${day.windSpeed},${day.comfortIndex}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                downloadFile(blob, 'weather-analysis.csv');
            }
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function generateShortTerm() {
            if (!selectedLocation) {
                alert('Please select a location first');
                return;
            }

            const btn = document.getElementById('shortBtn');
            btn.innerHTML = '<span class="loading"></span>Generating...';
            btn.disabled = true;

            const apiKey = document.getElementById('apiKey').value;
            const container = document.getElementById('shortterm-cards');

            if (apiKey) {
                try {
                    const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${selectedLocation.lat}&lon=${selectedLocation.lng}&appid=${apiKey}&units=metric`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    displayRealForecast(data, container);
                } catch (error) {
                    displayDemoForecast(container);
                }
            } else {
                displayDemoForecast(container);
            }

            btn.innerHTML = 'Forecast Generated';
            setTimeout(() => {
                btn.innerHTML = 'Generate 7-Day Forecast';
                btn.disabled = false;
            }, 2000);
        }

        function displayRealForecast(data, container) {
            const dailyData = {};
            data.list.forEach(item => {
                const date = item.dt_txt.split(' ')[0];
                if (!dailyData[date]) {
                    dailyData[date] = { temps: [], weather: item.weather[0], date: new Date(date) };
                }
                dailyData[date].temps.push(item.main.temp);
            });

            const days = Object.values(dailyData).slice(0, 7);
            container.innerHTML = days.map(day => {
                const avgTemp = (day.temps.reduce((a, b) => a + b, 0) / day.temps.length).toFixed(1);
                const icon = getWeatherIcon(day.weather.main);
                const dateStr = day.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                return `
                    <div class="forecast-card">
                        <div style="font-size: 14px; color: var(--text-secondary);">${dateStr}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temp">${avgTemp}°C</div>
                        <div style="font-size: 13px; color: var(--text-secondary);">${day.weather.description}</div>
                    </div>
                `;
            }).join('');
        }

        function displayDemoForecast(container) {
            const today = new Date();
            const demoData = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const temp = 20 + Math.random() * 15 + Math.sin(i / 7 * Math.PI) * 5;
                const conditions = ['Clear', 'Clouds', 'Rain', 'Partly Cloudy'];
                demoData.push({
                    date: date,
                    temp: temp.toFixed(1),
                    condition: conditions[Math.floor(Math.random() * conditions.length)]
                });
            }
            
            container.innerHTML = demoData.map(day => {
                const icon = getWeatherIcon(day.condition);
                const dateStr = day.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                return `
                    <div class="forecast-card">
                        <div style="font-size: 14px; color: var(--text-secondary);">${dateStr}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temp">${day.temp}°C</div>
                        <div style="font-size: 13px; color: var(--accent-orange);">Demo Mode</div>
                    </div>
                `;
            }).join('');
        }

        function getWeatherIcon(condition) {
            const icons = {
                'Clear': '☀️', 'Clouds': '☁️', 'Rain': '🌧️', 'Snow': '❄️',
                'Thunderstorm': '⛈️', 'Drizzle': '🌦️', 'Mist': '🌫️', 'Partly Cloudy': '⛅'
            };
            return icons[condition] || '🌤️';
        }

        async function generateMediumTerm() {
            if (!selectedLocation) {
                alert('Please select a location first');
                return;
            }

            const btn = document.getElementById('mediumBtn');
            btn.innerHTML = '<span class="loading"></span>Generating...';
            btn.disabled = true;

            const container = document.getElementById('mediumterm-content');
            container.innerHTML = `
                <h3 style="color: var(--accent-cyan); margin-bottom: 20px;">30-Day Probability Analysis</h3>
                <div class="probability-item">
                    <div><strong>Hot Days (>30°C)</strong></div>
                    <div class="probability-bar-container">
                        <div class="probability-bar-fill" style="width: 35%">35%</div>
                    </div>
                </div>
                <div class="probability-item">
                    <div><strong>Rainy Days (>5mm)</strong></div>
                    <div class="probability-bar-container">
                        <div class="probability-bar-fill" style="width: 25%">25%</div>
                    </div>
                </div>
                <div class="probability-item">
                    <div><strong>Windy Days (>8m/s)</strong></div>
                    <div class="probability-bar-container">
                        <div class="probability-bar-fill" style="width: 15%">15%</div>
                    </div>
                </div>
            `;

            const ctx = document.getElementById('mediumChart').getContext('2d');
            if (charts.medium) charts.medium.destroy();
            
            charts.medium = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 10}, (_, i) => `Day ${i*3}`),
                    datasets: [{
                        label: 'Predicted Temperature (°C)',
                        data: Array.from({length: 10}, () => 20 + Math.random() * 10),
                        borderColor: 'var(--accent-cyan)',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });

            btn.innerHTML = 'Outlook Generated';
            setTimeout(() => {
                btn.innerHTML = 'Generate 30-Day Outlook';
                btn.disabled = false;
            }, 2000);
        }

        function generateLongTerm() {
            if (!selectedLocation) {
                alert('Please select a location first');
                return;
            }

            const btn = document.getElementById('longBtn');
            btn.innerHTML = '<span class="loading"></span>Generating...';
            btn.disabled = true;

            const seasons = [
                { name: 'Winter', months: 'Dec-Feb', tempRange: '5-15°C', precipitation: 'High', icon: '❄️' },
                { name: 'Spring', months: 'Mar-May', tempRange: '15-25°C', precipitation: 'Moderate', icon: '🌸' },
                { name: 'Summer', months: 'Jun-Aug', tempRange: '25-35°C', precipitation: 'Low', icon: '☀️' },
                { name: 'Fall', months: 'Sep-Nov', tempRange: '15-25°C', precipitation: 'Moderate', icon: '🍂' }
            ];

            const container = document.getElementById('longterm-content');
            container.innerHTML = `
                <h3 style="color: var(--accent-purple); margin-bottom: 20px;">Seasonal Climate Outlook</h3>
                ${seasons.map(season => `
                    <div class="probability-item">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 32px;">${season.icon}</span>
                            <div>
                                <strong>${season.name}</strong> <small style="color: var(--text-secondary);">${season.months}</small>
                                <br><small style="color: var(--text-secondary);">${season.tempRange} | ${season.precipitation} Precipitation</small>
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;

            const ctx = document.getElementById('longtermChart').getContext('2d');
            if (charts.longterm) charts.longterm.destroy();
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const temps = [8, 10, 15, 20, 25, 30, 32, 31, 27, 21, 14, 9];
            
            charts.longterm = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Average Temperature (°C)',
                        data: temps,
                        borderColor: 'var(--accent-orange)',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });

            btn.innerHTML = 'Outlook Generated';
            setTimeout(() => {
                btn.innerHTML = 'Generate Seasonal Outlook';
                btn.disabled = false;
            }, 2000);
        }

        function showAlert(id, message, type) {
            const alert = document.getElementById(id);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }
    </script>
</body>
</html>