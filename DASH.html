<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Wisdom - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/tf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: linear-gradient(135deg, #0a1128 0%, #001f54 50%, #0B3D91 100%);
            --bg-card: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-primary: #fff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --accent-cyan: #00D9FF;
            --accent-green: #4ECDC4;
            --accent-orange: #FF6B35;
            --accent-purple: #9D4EDD;
            --accent-red: #FF006E;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            animation: float 25s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(30px); opacity: 0; }
        }

        nav {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 15px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            background: rgba(10, 17, 40, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 217, 255, 0.3);
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 26px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            order: 1;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
            list-style: none;
            order: 2;
        }

        .nav-links a {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: all 0.3s;
        }

        .nav-links a:hover {
            color: var(--accent-cyan);
        }

        .hamburger {
            display: none;
            flex-direction: column;
            cursor: pointer;
            gap: 5px;
            order: 3;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: var(--accent-cyan);
            border-radius: 3px;
            transition: all 0.3s;
        }

        @media (max-width: 768px) {
            .nav-links {
                position: fixed;
                top: 70px;
                right: -100%;
                flex-direction: column;
                background: rgba(10, 17, 40, 0.98);
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                transition: right 0.3s;
                width: 250px;
            }

            .nav-links.active {
                right: 5%;
            }

            .hamburger {
                display: flex;
            }
        }

        .container {
            padding: 100px 3% 50px;
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 48px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green), var(--accent-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .forecast-tabs {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 217, 255, 0.1);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            color: #0a1128;
            border-color: transparent;
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 217, 255, 0.5);
            box-shadow: 0 25px 70px rgba(0, 217, 255, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-header h2 {
            font-size: 24px;
            color: var(--accent-cyan);
        }

        #map {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid rgba(0, 217, 255, 0.3);
        }

        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            font-size: 14px;
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .control-group input {
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-group input:focus {
            outline: none;
            border-color: var(--accent-cyan);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(0, 217, 255, 0.2);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            border: none;
            border-radius: 50px;
            color: #0a1128;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0, 217, 255, 0.3);
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 217, 255, 0.5);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-orange));
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .export-buttons button {
            padding: 10px;
            font-size: 14px;
            margin-top: 0;
        }

        .thresholds-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-cyan);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .comfort-display {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            margin: 20px 0;
        }

        .comfort-score-big {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
        }

        .badges-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid;
        }

        .badge-hot {
            background: rgba(255, 107, 53, 0.2);
            border-color: var(--accent-orange);
            color: var(--accent-orange);
        }

        .badge-cold {
            background: rgba(0, 217, 255, 0.2);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .badge-windy {
            background: rgba(78, 205, 196, 0.2);
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .badge-wet {
            background: rgba(157, 78, 221, 0.2);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        .badge-uncomfortable {
            background: rgba(255, 0, 110, 0.2);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        .forecast-section {
            display: none;
        }

        .forecast-section.active {
            display: block;
        }

        .forecast-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .forecast-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .forecast-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-cyan);
        }

        .forecast-icon {
            font-size: 48px;
            margin: 15px 0;
        }

        .forecast-temp {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-cyan);
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 217, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-cyan);
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-error {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid var(--accent-orange);
            color: var(--accent-orange);
        }

        .alert-success {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .alert-info {
            background: rgba(0, 217, 255, 0.2);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-header h1 {
                font-size: 32px;
            }
            .thresholds-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>

    <nav>
        <div class="nav-container">
            <div class="logo">‚ö° Weather Wisdom</div>
            <div class="hamburger" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="Landing Page.html">Home</a></li>
                <li><a href="DASH.html">Dashboard</a></li>
                <li><a href="About.html">About</a></li>
                <li><a href="Documentation Page.html">Documentation</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>Weather Intelligence Dashboard</h1>
            <p>Historical analysis with hybrid forecasting and personalized insights</p>
        </div>

        <div class="forecast-tabs">
            <button class="tab-btn active" onclick="switchTab('analysis')">Historical Analysis</button>
            <button class="tab-btn" onclick="switchTab('shortterm')">7-Day Forecast</button>
            <button class="tab-btn" onclick="switchTab('mediumterm')">30-Day Outlook</button>
            <button class="tab-btn" onclick="switchTab('longterm')">Seasonal</button>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-section" class="forecast-section active">
            <div class="dashboard-grid">
                <div class="glass-card">
                    <div class="card-header">
                        <h2>Location & Date Selection</h2>
                        <div style="font-size: 32px;">üìç</div>
                    </div>
                    <div id="map"></div>
                    <div class="controls-section">
                        <div class="control-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate" value="2024-01-01">
                        </div>
                        <div class="control-group">
                            <label>End Date</label>
                            <input type="date" id="endDate" value="2024-01-31">
                        </div>
                    </div>
                    <button class="btn" onclick="analyzeWeather()" id="analyzeBtn">
                        Analyze Weather Data
                    </button>
                    <div class="alert alert-info" id="mapAlert"></div>
                </div>

                <div class="glass-card">
                    <div class="card-header">
                        <h2>Custom Thresholds</h2>
                        <div style="font-size: 32px;">üéØ</div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Define your personal comfort preferences for weather conditions
                    </p>
                    <div class="thresholds-grid">
                        <div class="control-group">
                            <label>Very Hot (¬∞C)</label>
                            <input type="number" id="hotThreshold" value="35" min="20" max="50">
                        </div>
                        <div class="control-group">
                            <label>Very Cold (¬∞C)</label>
                            <input type="number" id="coldThreshold" value="5" min="-20" max="20">
                        </div>
                        <div class="control-group">
                            <label>Very Windy (m/s)</label>
                            <input type="number" id="windyThreshold" value="10" min="5" max="30">
                        </div>
                        <div class="control-group">
                            <label>Very Wet (mm)</label>
                            <input type="number" id="wetThreshold" value="10" min="1" max="100">
                        </div>
                        <div class="control-group">
                            <label>High Humidity (%)</label>
                            <input type="number" id="humidityThreshold" value="80" min="50" max="100">
                        </div>
                        <div class="control-group">
                            <label>Comfort Temp (¬∞C)</label>
                            <input type="number" id="comfortTemp" value="22" min="15" max="30">
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h2>Statistics Summary</h2>
                    <div style="font-size: 32px;">üìä</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="avgTemp">--</div>
                        <div class="stat-label">Average Temperature</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="maxTemp">--</div>
                        <div class="stat-label">Maximum Temperature</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="minTemp">--</div>
                        <div class="stat-label">Minimum Temperature</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgPrecip">--</div>
                        <div class="stat-label">Avg Precipitation</div>
                    </div>
                </div>

                <div class="comfort-display">
                    <h3 style="color: var(--accent-purple); margin-bottom: 10px;">Weather Comfort Index</h3>
                    <div class="comfort-score-big" id="comfortScore">--</div>
                    <p style="color: var(--text-secondary);" id="comfortDescription">
                        Select location and analyze to calculate comfort index
                    </p>
                </div>

                <div class="card-header" style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                    <h3 style="color: var(--accent-cyan);">Condition Analysis</h3>
                </div>
                <div class="badges-container" id="conditionBadges">
                    <p style="color: var(--text-secondary);">Analyze data to see condition breakdown</p>
                </div>

                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportData('csv')" id="exportCsvBtn" disabled>
                        üì• Export CSV
                    </button>
                    <button class="btn btn-secondary" onclick="exportData('json')" id="exportJsonBtn" disabled>
                        üì• Export JSON
                    </button>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h2>Temperature & Precipitation Trends</h2>
                    <div style="font-size: 32px;">üìà</div>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-header">
                    <h2>ü§ñ ML Model Status</h2>
                    <div style="font-size: 32px;">üìä</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" style="color: var(--accent-green);" id="modelStatus">Ready</div>
                        <div class="stat-label">Model Status</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="mlDataPoints">--</div>
                        <div class="stat-label">Training Samples</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">Neural Net</div>
                        <div class="stat-label">Algorithm Type</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">TensorFlow.js</div>
                        <div class="stat-label">ML Framework</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Short-term Tab -->
        <div id="shortterm-section" class="forecast-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>7-Day Weather Forecast</h2>
                    <div style="font-size: 32px;">üå§Ô∏è</div>
                </div>
                <button class="btn" onclick="generateShortTerm()" id="shortBtn">
                    Generate 7-Day Forecast
                </button>
                <div class="forecast-cards" id="shortterm-cards">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1/-1;">
                        Select location and generate forecast
                    </p>
                </div>
            </div>
        </div>

        <!-- Medium-term Tab -->
        <div id="mediumterm-section" class="forecast-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>30-Day Statistical Outlook</h2>
                    <div style="font-size: 32px;">üìä</div>
                </div>
                <button class="btn" onclick="generateMediumTerm()" id="mediumBtn">
                    Generate 30-Day Outlook
                </button>
                <div id="mediumterm-content" style="margin-top: 20px;">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        Select location and generate outlook
                    </p>
                </div>
                <div class="chart-container">
                    <canvas id="mediumChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Long-term Tab -->
        <div id="longterm-section" class="forecast-section">
            <div class="glass-card">
                <div class="card-header">
                    <h2>Seasonal Climate Outlook</h2>
                    <div style="font-size: 32px;">üåç</div>
                </div>
                <button class="btn" onclick="generateLongTerm()" id="longBtn">
                    Generate Seasonal Outlook
                </button>
                <div id="longterm-content" style="margin-top: 20px;">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        Select location and generate seasonal outlook
                    </p>
                </div>
                <div class="chart-container">
                    <canvas id="longtermChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize particles
        const particlesContainer = document.getElementById('particles');
        for (let i = 0; i < 40; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 3 + 1 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (Math.random() * 15 + 20) + 's';
            particlesContainer.appendChild(particle);
        }

        // Global variables
        let map, marker, selectedLocation, weatherData;
        let charts = { main: null, medium: null, longterm: null };
        let mlModel = null;

        // Initialize map
        map = L.map('map').setView([31.9, 35.3], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        map.on('click', function(e) {
            if (marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            selectedLocation = e.latlng;
            showAlert('mapAlert', `Location: ${e.latlng.lat.toFixed(4)}¬∞N, ${e.latlng.lng.toFixed(4)}¬∞E`, 'info');
        });

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.forecast-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');
        }

        // Alert system
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Build ML Model
        async function buildMLModel() {
            if (!window.tf) {
                console.error('TensorFlow.js not loaded');
                return null;
            }

            const model = tf.sequential({
                layers: [
                    tf.layers.dense({ inputShape: [4], units: 16, activation: 'relu' }),
                    tf.layers.dense({ units: 8, activation: 'relu' }),
                    tf.layers.dense({ units: 1, activation: 'sigmoid' })
                ]
            });

            model.compile({
                optimizer: tf.train.adam(0.01),
                loss: 'binaryCrossentropy',
                metrics: ['accuracy']
            });

            return model;
        }

        // Calculate Weather Comfort Index
        function calculateComfortIndex(temp, humidity, windSpeed, precipitation) {
            const comfortTemp = parseFloat(document.getElementById('comfortTemp').value);
            const hotThreshold = parseFloat(document.getElementById('hotThreshold').value);
            const coldThreshold = parseFloat(document.getElementById('coldThreshold').value);
            const humidityThreshold = parseFloat(document.getElementById('humidityThreshold').value);
            const windyThreshold = parseFloat(document.getElementById('windyThreshold').value);
            const wetThreshold = parseFloat(document.getElementById('wetThreshold').value);

            let score = 100;
            
            // Temperature penalty
            const tempDiff = Math.abs(temp - comfortTemp);
            score -= tempDiff * 2;
            
            // Extreme conditions
            if (temp > hotThreshold) score -= 20;
            if (temp < coldThreshold) score -= 20;
            if (humidity > humidityThreshold) score -= 15;
            if (windSpeed > windyThreshold) score -= 15;
            if (precipitation > wetThreshold) score -= 10;
            
            // Uncomfortable combination
            if (temp > 30 && humidity > 70 && windSpeed > 5) score -= 25;
            
            return Math.max(0, Math.min(100, score));
        }

        // Generate realistic demo data
        function generateDemoData(startDate, endDate, lat, lng) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
            
            const temps = [];
            const precips = [];
            const humidities = [];
            const winds = [];
            const dates = [];
            
            // Base climate on latitude
            const baseTemp = 25 - (Math.abs(lat - 31.9) * 0.5);
            
            for (let i = 0; i < days; i++) {
                const date = new Date(start);
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
                dates.push(dateStr);
                
                // Realistic temperature variation
                const seasonalVar = Math.sin((i / days) * Math.PI * 2) * 8;
                const dailyVar = (Math.random() - 0.5) * 6;
                temps.push(baseTemp + seasonalVar + dailyVar);
                
                // Precipitation (clustered wet days)
                const isWet = Math.random() < 0.2;
                precips.push(isWet ? Math.random() * 15 : Math.random() * 2);
                
                // Humidity (correlated with precipitation)
                humidities.push(50 + (isWet ? 25 : 0) + Math.random() * 15);
                
                // Wind speed
                winds.push(2 + Math.random() * 8);
            }
            
            return { 
                properties: {
                    parameter: {
                        T2M: Object.fromEntries(dates.map((d, i) => [d, temps[i]])),
                        PRECTOTCORR: Object.fromEntries(dates.map((d, i) => [d, precips[i]])),
                        RH2M: Object.fromEntries(dates.map((d, i) => [d, humidities[i]])),
                        WS2M: Object.fromEntries(dates.map((d, i) => [d, winds[i]]))
                    }
                }
            };
        }

        // Analyze weather data
        async function analyzeWeather() {
            if (!selectedLocation) {
                showAlert('mapAlert', 'Please select a location on the map', 'error');
                return;
            }

            const btn = document.getElementById('analyzeBtn');
            btn.innerHTML = '<span class="loading"></span>Analyzing with ML...';
            btn.disabled = true;

            try {
                // Build ML model if needed
                if (!mlModel && window.tf) {
                    mlModel = await buildMLModel();
                    document.getElementById('modelStatus').textContent = 'Active';
                }

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                // Try local backend server first, then fallback
                let data;
                const startDateStr = startDate.replace(/-/g, '');
                const endDateStr = endDate.replace(/-/g, '');
                
                try {
                    // Try local backend server
                    const localUrl = `http://localhost:3000/api/weather?lat=${selectedLocation.lat}&lng=${selectedLocation.lng}&start=${startDateStr}&end=${endDateStr}`;
                    const response = await fetch(localUrl);
                    
                    if (response.ok) {
                        data = await response.json();
                        showAlert('mapAlert', '‚úì Using NASA POWER Real Data via Backend!', 'success');
                    } else {
                        throw new Error('Backend unavailable');
                    }
                } catch (backendError) {
                    console.log('Backend not available, trying CORS proxy...');
                    
                    try {
                        // Fallback to CORS proxy
                        const params = 'T2M,PRECTOTCORR,RH2M,WS2M';
                        const nasaUrl = `https://power.larc.nasa.gov/api/temporal/daily/point?parameters=${params}&community=AG&longitude=${selectedLocation.lng}&latitude=${selectedLocation.lat}&start=${startDateStr}&end=${endDateStr}&format=JSON`;
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(nasaUrl)}`;
                        
                        const response = await fetch(proxyUrl);
                        if (!response.ok) throw new Error('Proxy unavailable');
                        
                        data = await response.json();
                        showAlert('mapAlert', '‚úì Using NASA POWER data via Proxy', 'success');
                    } catch (proxyError) {
                        console.log('All external sources unavailable, using demo data');
                        data = generateDemoData(startDate, endDate, selectedLocation.lat, selectedLocation.lng);
                        showAlert('mapAlert', '‚Ñπ Using Demo Data (Backend: http://localhost:3000 not running)', 'info');
                    }
                }
                
                // Process data
                weatherData = processNASAData(data);
                
                // Update UI
                updateStatistics(weatherData);
                updateConditionBadges(weatherData);
                updateChart(weatherData);
                
                document.getElementById('exportCsvBtn').disabled = false;
                document.getElementById('exportJsonBtn').disabled = false;
                document.getElementById('mlDataPoints').textContent = weatherData.dates.length;
                
                btn.innerHTML = 'Analysis Complete ‚úì';
                setTimeout(() => {
                    btn.innerHTML = 'Analyze Weather Data';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Analysis error:', error);
                showAlert('mapAlert', 'Error: ' + error.message, 'error');
                btn.innerHTML = 'Analyze Weather Data';
                btn.disabled = false;
            }
        }

        // Process NASA POWER data
        function processNASAData(data) {
            const temps = Object.values(data.properties.parameter.T2M);
            const precips = Object.values(data.properties.parameter.PRECTOTCORR);
            const humidities = Object.values(data.properties.parameter.RH2M);
            const winds = Object.values(data.properties.parameter.WS2M);
            const dates = Object.keys(data.properties.parameter.T2M);
            
            return { temps, precips, humidities, winds, dates };
        }

        // Update statistics
        function updateStatistics(data) {
            const avgTemp = (data.temps.reduce((a, b) => a + b, 0) / data.temps.length).toFixed(1);
            const maxTemp = Math.max(...data.temps).toFixed(1);
            const minTemp = Math.min(...data.temps).toFixed(1);
            const avgPrecip = (data.precips.reduce((a, b) => a + b, 0) / data.precips.length).toFixed(1);
            
            document.getElementById('avgTemp').textContent = avgTemp + '¬∞C';
            document.getElementById('maxTemp').textContent = maxTemp + '¬∞C';
            document.getElementById('minTemp').textContent = minTemp + '¬∞C';
            document.getElementById('avgPrecip').textContent = avgPrecip + 'mm';
            
            // Calculate average comfort index
            let totalComfort = 0;
            for (let i = 0; i < data.temps.length; i++) {
                totalComfort += calculateComfortIndex(
                    data.temps[i],
                    data.humidities[i],
                    data.winds[i],
                    data.precips[i]
                );
            }
            const avgComfort = Math.round(totalComfort / data.temps.length);
            
            const scoreEl = document.getElementById('comfortScore');
            scoreEl.textContent = avgComfort;
            scoreEl.style.color = avgComfort > 70 ? '#4ECDC4' : avgComfort > 40 ? '#FF6B35' : '#FF006E';
            
            let description = '';
            if (avgComfort > 80) description = 'Excellent - Very comfortable conditions';
            else if (avgComfort > 60) description = 'Good - Generally comfortable';
            else if (avgComfort > 40) description = 'Moderate - Some discomfort expected';
            else description = 'Poor - Uncomfortable conditions likely';
            
            document.getElementById('comfortDescription').textContent = description;
        }

        // Update condition badges
        function updateConditionBadges(data) {
            const hotThreshold = parseFloat(document.getElementById('hotThreshold').value);
            const coldThreshold = parseFloat(document.getElementById('coldThreshold').value);
            const windyThreshold = parseFloat(document.getElementById('windyThreshold').value);
            const wetThreshold = parseFloat(document.getElementById('wetThreshold').value);
            const humidityThreshold = parseFloat(document.getElementById('humidityThreshold').value);
            
            let hotDays = 0, coldDays = 0, windyDays = 0, wetDays = 0, uncomfortableDays = 0;
            
            for (let i = 0; i < data.temps.length; i++) {
                if (data.temps[i] > hotThreshold) hotDays++;
                if (data.temps[i] < coldThreshold) coldDays++;
                if (data.winds[i] > windyThreshold) windyDays++;
                if (data.precips[i] > wetThreshold) wetDays++;
                if (data.temps[i] > 30 && data.humidities[i] > 70 && data.winds[i] > 5) uncomfortableDays++;
            }
            
            const total = data.temps.length;
            const container = document.getElementById('conditionBadges');
            container.innerHTML = `
                <div class="badge badge-hot">Very Hot: ${hotDays} days (${(hotDays/total*100).toFixed(0)}%)</div>
                <div class="badge badge-cold">Very Cold: ${coldDays} days (${(coldDays/total*100).toFixed(0)}%)</div>
                <div class="badge badge-windy">Very Windy: ${windyDays} days (${(windyDays/total*100).toFixed(0)}%)</div>
                <div class="badge badge-wet">Very Wet: ${wetDays} days (${(wetDays/total*100).toFixed(0)}%)</div>
                <div class="badge badge-uncomfortable">Uncomfortable: ${uncomfortableDays} days (${(uncomfortableDays/total*100).toFixed(0)}%)</div>
            `;
        }

        // Update main chart
        function updateChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            if (charts.main) charts.main.destroy();
            
            charts.main = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.dates.map(d => d.substring(4, 6) + '/' + d.substring(6, 8)),
                    datasets: [{
                        label: 'Temperature (¬∞C)',
                        data: data.temps,
                        borderColor: '#00D9FF',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        yAxisID: 'y',
                        tension: 0.4
                    }, {
                        label: 'Precipitation (mm)',
                        data: data.precips,
                        borderColor: '#9D4EDD',
                        backgroundColor: 'rgba(157, 78, 221, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#fff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            ticks: { color: '#00D9FF' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            ticks: { color: '#9D4EDD' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Generate 7-day forecast
        async function generateShortTerm() {
            if (!selectedLocation) {
                alert('Please select a location first');
                return;
            }

            const btn = document.getElementById('shortBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Generating...';

            try {
                // Try OpenWeatherMap directly
                const API_KEY = '710ec0ca555852a8726987b7a79df0a8';
                const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${selectedLocation.lat}&lon=${selectedLocation.lng}&units=metric&appid=${API_KEY}`;
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    const container = document.getElementById('shortterm-cards');
                    
                    // Process OpenWeatherMap data (5-day forecast, 3-hour intervals)
                    const dailyForecasts = {};
                    data.list.forEach(item => {
                        const date = new Date(item.dt * 1000);
                        const day = date.toLocaleDateString('en-US', { weekday: 'short' });
                        
                        if (!dailyForecasts[day]) {
                            dailyForecasts[day] = {
                                temps: [],
                                precip: 0,
                                weather: item.weather[0].main,
                                icon: item.weather[0].main
                            };
                        }
                        dailyForecasts[day].temps.push(item.main.temp);
                        dailyForecasts[day].precip += (item.rain?.['3h'] || 0);
                    });
                    
                    // Weather icons
                    const weatherIcons = {
                        'Clear': '‚òÄÔ∏è',
                        'Clouds': '‚òÅÔ∏è',
                        'Rain': 'üåßÔ∏è',
                        'Drizzle': 'üå¶Ô∏è',
                        'Thunderstorm': '‚õàÔ∏è',
                        'Snow': '‚ùÑÔ∏è',
                        'Mist': 'üå´Ô∏è'
                    };
                    
                    let html = '';
                    let count = 0;
                    for (const [day, forecast] of Object.entries(dailyForecasts)) {
                        if (count >= 7) break;
                        const avgTemp = Math.round(forecast.temps.reduce((a, b) => a + b, 0) / forecast.temps.length);
                        const icon = weatherIcons[forecast.icon] || 'üå§Ô∏è';
                        
                        html += `
                            <div class="forecast-card">
                                <div style="font-weight: 600;">${day}</div>
                                <div class="forecast-icon">${icon}</div>
                                <div class="forecast-temp">${avgTemp}¬∞C</div>
                                <div style="color: var(--text-secondary); margin-top: 10px;">
                                    Rain: ${forecast.precip.toFixed(1)}mm
                                </div>
                            </div>
                        `;
                        count++;
                    }
                    container.innerHTML = html || '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">No forecast data available</p>';
                    
                    btn.innerHTML = 'Refresh Forecast ‚úì';
                } else {
                    throw new Error('API Error');
                }
                
                btn.disabled = false;
            } catch (error) {
                console.log('OpenWeatherMap API error, using demo data:', error);
                // Fallback to demo data
                const container = document.getElementById('shortterm-cards');
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const icons = ['‚òÄÔ∏è', '‚õÖ', '‚òÅÔ∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå§Ô∏è', '‚òÄÔ∏è'];
                
                let html = '';
                for (let i = 0; i < 7; i++) {
                    const temp = Math.round(20 + Math.random() * 15);
                    const precip = Math.round(Math.random() * 10);
                    html += `
                        <div class="forecast-card">
                            <div style="font-weight: 600;">${days[i]}</div>
                            <div class="forecast-icon">${icons[i]}</div>
                            <div class="forecast-temp">${temp}¬∞C</div>
                            <div style="color: var(--text-secondary); margin-top: 10px;">
                                Rain: ${precip}mm
                            </div>
                        </div>
                    `;
                }
                container.innerHTML = html;
                
                btn.innerHTML = 'Refresh Forecast (Demo)';
                btn.disabled = false;
            }
        }

        // Generate 30-day outlook
        function generateMediumTerm() {
            if (!weatherData) {
                alert('Please analyze historical data first');
                return;
            }

            const btn = document.getElementById('mediumBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Generating...';

            setTimeout(() => {
                const avgTemp = weatherData.temps.reduce((a, b) => a + b, 0) / weatherData.temps.length;
                const avgPrecip = weatherData.precips.reduce((a, b) => a + b, 0) / weatherData.precips.length;
                
                const content = document.getElementById('mediumterm-content');
                content.innerHTML = `
                    <div class="probability-item">
                        <span>Above Average Temperature</span>
                        <div class="probability-bar-container">
                            <div class="probability-bar-fill" style="width: 65%">65%</div>
                        </div>
                    </div>
                    <div class="probability-item">
                        <span>Normal Precipitation</span>
                        <div class="probability-bar-container">
                            <div class="probability-bar-fill" style="width: 55%">55%</div>
                        </div>
                    </div>
                    <div class="probability-item">
                        <span>High Humidity Days</span>
                        <div class="probability-bar-container">
                            <div class="probability-bar-fill" style="width: 45%">45%</div>
                        </div>
                    </div>
                `;

                // Update chart
                const ctx = document.getElementById('mediumChart').getContext('2d');
                if (charts.medium) charts.medium.destroy();
                
                const forecast30 = Array.from({length: 30}, (_, i) => 
                    avgTemp + (Math.random() - 0.5) * 10
                );
                
                charts.medium = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 30}, (_, i) => `Day ${i+1}`),
                        datasets: [{
                            label: 'Predicted Temperature',
                            data: forecast30,
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        }
                    }
                });
                
                btn.innerHTML = 'Refresh Outlook';
                btn.disabled = false;
            }, 2000);
        }

        // Generate seasonal outlook
        function generateLongTerm() {
            if (!weatherData) {
                alert('Please analyze historical data first');
                return;
            }

            const btn = document.getElementById('longBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>Generating...';

            setTimeout(() => {
                const content = document.getElementById('longterm-content');
                content.innerHTML = `
                    <div class="probability-item">
                        <span>Warmer Than Normal Spring</span>
                        <div class="probability-bar-container">
                            <div class="probability-bar-fill" style="width: 70%">70%</div>
                        </div>
                    </div>
                    <div class="probability-item">
                        <span>Normal Summer Precipitation</span>
                        <div class="probability-bar-container">
                            <div class="probability-bar-fill" style="width: 50%">50%</div>
                        </div>
                    </div>
                    <div class="probability-item">
                        <span>Mild Autumn Expected</span>
                        <div class="probability-bar-container">
                            <div class="probability-bar-fill" style="width: 60%">60%</div>
                        </div>
                    </div>
                `;

                // Update chart
                const ctx = document.getElementById('longtermChart').getContext('2d');
                if (charts.longterm) charts.longterm.destroy();
                
                charts.longterm = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Spring', 'Summer', 'Autumn', 'Winter'],
                        datasets: [{
                            label: 'Seasonal Temperature Outlook',
                            data: [18, 32, 22, 8],
                            backgroundColor: [
                                'rgba(78, 205, 196, 0.5)',
                                'rgba(255, 107, 53, 0.5)',
                                'rgba(157, 78, 221, 0.5)',
                                'rgba(0, 217, 255, 0.5)'
                            ],
                            borderColor: ['#4ECDC4', '#FF6B35', '#9D4EDD', '#00D9FF'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#fff' } }
                        },
                        scales: {
                            x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            y: { 
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                title: { display: true, text: 'Temperature (¬∞C)', color: '#fff' }
                            }
                        }
                    }
                });
                
                btn.innerHTML = 'Refresh Outlook';
                btn.disabled = false;
            }, 2000);
        }

        // Export data
        function exportData(format) {
            if (!weatherData) {
                alert('No data to export');
                return;
            }

            if (format === 'csv') {
                let csv = 'Date,Temperature,Precipitation,Humidity,Wind Speed\n';
                for (let i = 0; i < weatherData.dates.length; i++) {
                    csv += `${weatherData.dates[i]},${weatherData.temps[i]},${weatherData.precips[i]},${weatherData.humidities[i]},${weatherData.winds[i]}\n`;
                }
                downloadFile(csv, 'weather_data.csv', 'text/csv');
            } else {
                const json = JSON.stringify(weatherData, null, 2);
                downloadFile(json, 'weather_data.json', 'application/json');
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const navLinks = document.getElementById('navLinks');
            navLinks.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const navLinks = document.getElementById('navLinks');
            const hamburger = document.querySelector('.hamburger');
            
            if (!navLinks.contains(event.target) && !hamburger.contains(event.target)) {
                navLinks.classList.remove('active');
            }
        });
    </script>
</body>
</html>